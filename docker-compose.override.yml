version: '3.8'

services:
  # Development configuration for backend
  backend:
    build:
      context: ./src/backend
      dockerfile: Dockerfile.dev
    volumes:
      - ./src/backend:/app
      - /app/node_modules
    environment:
      NODE_ENV: development
      OPENAI_API_KEY: ${OPENAI_API_KEY:-demo-key-for-development}
    command: npm run dev

  # Frontend configuration for Cloudflare tunnel access
  # Uses production build served via vite preview
  frontend:
    build:
      context: ./src/frontend
      dockerfile: Dockerfile.dev
    volumes:
      - ./src/frontend:/app
      - /app/node_modules
    environment:
      NODE_ENV: production
      VITE_API_URL: https://psscript.morloksmaze.com/api
    ports:
      - "3000:3000"
    command: sh -c "npx vite build && npx vite preview --host 0.0.0.0 --port 3000"

  # Development configuration for AI service
  ai-service:
    build:
      context: ./src/ai
      dockerfile: Dockerfile.dev
    volumes:
      - ./src/ai:/app
    environment:
      FLASK_ENV: development
      FLASK_DEBUG: 1
      MOCK_MODE: "true"  # Enable mock mode for development
      OPENAI_API_KEY: ${OPENAI_API_KEY:-demo-key-for-development}
    command: uvicorn main:app --host=0.0.0.0 --port=8000 --reload
    ports:
      - "8000:8000"

  # Development tools
  pgadmin:
    image: dpage/pgadmin4
    container_name: psscript-pgadmin
    restart: unless-stopped
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@example.com
      PGADMIN_DEFAULT_PASSWORD: admin
    ports:
      - "5050:80"
    depends_on:
      - postgres

  # Redis commander for Redis management
  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: psscript-redis-commander
    restart: unless-stopped
    environment:
      REDIS_HOSTS: local:redis:6379
    ports:
      - "8082:8081"
    depends_on:
      - redis
