services:
  # Development configuration for backend
  backend:
    build:
      context: ./src/backend
      dockerfile: Dockerfile.dev
    volumes:
      - ./src/backend:/app
      - /app/node_modules
      - ./docs:/docs
      - ./certs:/certs:ro
    environment:
      NODE_ENV: development
      OPENAI_API_KEY: ${OPENAI_API_KEY:-demo-key-for-development}
      DOCKER_ENV: "true"
      PORT: "4000"
      DISABLE_AUTH: "true"
      # Allow stress/E2E without constant 429s in dev.
      RELAX_RATE_LIMITS: "true"
      RATE_LIMIT_MULTIPLIER: "20"
      DB_HOST: postgres
      DB_PORT: "5432"
      DB_NAME: psscript
      DB_USER: postgres
      DB_PASSWORD: postgres
      REDIS_URL: redis://redis:6379
      AI_SERVICE_URL: http://ai-service:8000
      JWT_SECRET: development_jwt_secret_key_change_in_production
      TLS_CERT: /certs/backend.crt
      TLS_KEY: /certs/backend.key
    command: npm run dev
    restart: unless-stopped

  # Frontend configuration for Cloudflare tunnel access
  # Use Vite dev server to avoid expensive build-on-start (can OOM and kill backend/db).
  frontend:
    build:
      context: ./src/frontend
      dockerfile: Dockerfile.dev
    volumes:
      - ./src/frontend:/app
      - /app/node_modules
      - ./certs:/certs:ro
    environment:
      NODE_ENV: development
      # Let frontend runtime-detect API URL (works for local + tunnel)
      VITE_API_URL:
      VITE_PORT: "3090"
      # Enable demo login button for local dev/e2e
      # Matches seeded dev admin in src/db/seeds/01-initial-data.sql
      VITE_DEMO_EMAIL: admin@example.com
      VITE_DEMO_PASSWORD: admin123
      VITE_DISABLE_AUTH: "true"
      TLS_CERT: /certs/frontend.crt
      TLS_KEY: /certs/frontend.key
    ports:
      - "3090:3090"
    command: npm run dev -- --host 0.0.0.0 --port 3090
    restart: unless-stopped

  # Development configuration for AI service
  ai-service:
    build:
      context: ./src/ai
      dockerfile: Dockerfile.dev
    volumes:
      - ./src/ai:/app
    environment:
      FLASK_ENV: development
      FLASK_DEBUG: 1
      # Default to mock mode in dev to keep the app responsive and deterministic.
      # Set MOCK_MODE=false in your shell/.env when you want real provider calls.
      MOCK_MODE: ${MOCK_MODE:-true}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-demo-key-for-development}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
    command: uvicorn main:app --host=0.0.0.0 --port=8000 --reload
    ports:
      - "8000:8000"
    restart: unless-stopped

  # Development tools
  pgadmin:
    image: dpage/pgadmin4
    container_name: psscript-pgadmin
    restart: unless-stopped
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@example.com
      PGADMIN_DEFAULT_PASSWORD: admin
    ports:
      - "5050:80"
    depends_on:
      - postgres

  # Redis commander for Redis management
  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: psscript-redis-commander
    restart: unless-stopped
    environment:
      REDIS_HOSTS: local:redis:6379
    ports:
      - "8082:8081"
    depends_on:
      - redis
